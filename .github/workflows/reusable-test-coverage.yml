name: Reusable Test & Coverage

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      
      maven-args:
        description: 'Additional Maven arguments'
        required: false
        type: string
        default: ''
      
      coverage-threshold:
        description: 'Minimum coverage percentage required'
        required: false
        type: number
        default: 0
      
      fail-below-threshold:
        description: 'Fail build if coverage below threshold'
        required: false
        type: boolean
        default: false

    outputs:
      coverage-percentage:
        description: 'Code coverage percentage'
        value: ${{ jobs.test-coverage.outputs.coverage }}
      
      lines-covered:
        description: 'Number of lines covered'
        value: ${{ jobs.test-coverage.outputs.covered }}
      
      lines-total:
        description: 'Total number of lines'
        value: ${{ jobs.test-coverage.outputs.total }}
      
      tests-passed:
        description: 'Whether all tests passed'
        value: ${{ jobs.test-coverage.outputs.tests-passed }}

jobs:
  test-coverage:
    name: Tests & Coverage Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
      covered: ${{ steps.coverage.outputs.covered }}
      total: ${{ steps.coverage.outputs.total }}
      tests-passed: ${{ steps.test.outcome == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: 'maven'
      
      # Run tests with coverage
      - name: Run tests with JaCoCo coverage
        id: test
        run: |
          echo "ğŸ§ª Running tests with code coverage..."
          mvn clean test jacoco:report ${{ inputs.maven-args }} --batch-mode
      
      # Calculate coverage percentage
      - name: Calculate coverage
        id: coverage
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Calculating Code Coverage"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          COVERAGE_REPORT="target/site/jacoco/jacoco.xml"
          
          if [ ! -f "$COVERAGE_REPORT" ]; then
            echo "âŒ Coverage report not found at $COVERAGE_REPORT"
            echo "Make sure JaCoCo plugin is configured in pom.xml"
            exit 1
          fi
          
          # Extract metrics from JaCoCo XML
          MISSED=$(grep -oP '<counter type="LINE".*?missed="\K[0-9]+' $COVERAGE_REPORT | head -1)
          COVERED=$(grep -oP '<counter type="LINE".*?covered="\K[0-9]+' $COVERAGE_REPORT | head -1)
          
          # Calculate total and percentage
          TOTAL=$((MISSED + COVERED))
          
          if [ $TOTAL -eq 0 ]; then
            PERCENTAGE=0
            echo "âš ï¸  No code to analyze"
          else
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED / $TOTAL) * 100}")
          fi
          
          # Determine status
          THRESHOLD=${{ inputs.coverage-threshold }}
          
          if (( $(echo "$PERCENTAGE >= 80" | bc -l) )); then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Excellent"
            STATUS_COLOR="ğŸŸ¢"
          elif (( $(echo "$PERCENTAGE >= 60" | bc -l) )); then
            STATUS_EMOJI="ğŸ“Š"
            STATUS_TEXT="Good"
            STATUS_COLOR="ğŸŸ¡"
          elif (( $(echo "$PERCENTAGE >= 40" | bc -l) )); then
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="Needs Improvement"
            STATUS_COLOR="ğŸŸ "
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Poor"
            STATUS_COLOR="ğŸ”´"
          fi
          
          # Log results
          echo ""
          echo "ğŸ“ˆ Coverage Metrics:"
          echo "  Lines Covered:    $COVERED"
          echo "  Lines Missed:     $MISSED"
          echo "  Total Lines:      $TOTAL"
          echo "  Coverage:         $PERCENTAGE%"
          echo ""
          echo "$STATUS_COLOR Status: $STATUS_TEXT ($STATUS_EMOJI)"
          
          if [ $THRESHOLD -gt 0 ]; then
            echo "  Threshold:        $THRESHOLD%"
            if (( $(echo "$PERCENTAGE >= $THRESHOLD" | bc -l) )); then
              echo "  Result:           âœ… Passed"
            else
              echo "  Result:           âŒ Failed"
            fi
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Set outputs
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "covered=$COVERED" >> $GITHUB_OUTPUT
          echo "missed=$MISSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
          
          # Check threshold
          if [ $THRESHOLD -gt 0 ] && (( $(echo "$PERCENTAGE < $THRESHOLD" | bc -l) )); then
            echo "threshold_passed=false" >> $GITHUB_OUTPUT
          else
            echo "threshold_passed=true" >> $GITHUB_OUTPUT
          fi
      
      # Generate badge and detailed report
      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-coverage-badge: true
          generate-summary: true
      
      # Calculate coverage by package
      - name: Analyze coverage by package
        id: package-coverage
        run: |
          echo "ğŸ“¦ Analyzing coverage by package..."
          
          JACOCO_CSV="target/site/jacoco/jacoco.csv"
          
          if [ -f "$JACOCO_CSV" ]; then
            echo "package_breakdown<<EOF" >> $GITHUB_OUTPUT
            
            # Parse CSV and calculate per-package coverage
            tail -n +2 "$JACOCO_CSV" | while IFS=',' read -r group package class instruction_missed instruction_covered branch_missed branch_covered line_missed line_covered complexity_missed complexity_covered method_missed method_covered; do
              if [ "$class" != "TOTAL" ] && [ -n "$package" ]; then
                total_lines=$((line_missed + line_covered))
                if [ $total_lines -gt 0 ]; then
                  pkg_coverage=$(awk "BEGIN {printf \"%.1f\", ($line_covered / $total_lines) * 100}")
                  echo "$package: $pkg_coverage%"
                fi
              fi
            done | sort -t: -k2 -n -r | head -10 >> $GITHUB_OUTPUT
            
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  CSV file not found, skipping package analysis"
          fi
      
      # Upload coverage report as artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 7
      
      # Comment on PR with coverage
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const covered = '${{ steps.coverage.outputs.covered }}';
            const missed = '${{ steps.coverage.outputs.missed }}';
            const total = '${{ steps.coverage.outputs.total }}';
            const percentage = '${{ steps.coverage.outputs.percentage }}';
            const statusEmoji = '${{ steps.coverage.outputs.status_emoji }}';
            const statusText = '${{ steps.coverage.outputs.status_text }}';
            const statusColor = '${{ steps.coverage.outputs.status_color }}';
            const threshold = '${{ inputs.coverage-threshold }}';
            const thresholdPassed = '${{ steps.coverage.outputs.threshold_passed }}';
            
            let commentBody = `## ğŸ“Š Code Coverage Report (Local)\n\n`;
            
            // Status header
            if (threshold > 0) {
              if (thresholdPassed === 'true') {
                commentBody += `### âœ… Coverage Check Passed\n\n`;
              } else {
                commentBody += `### âŒ Coverage Below Threshold\n\n`;
              }
            } else {
              commentBody += `### ${statusEmoji} Coverage: ${percentage}% - ${statusText}\n\n`;
            }
            
            // Main metrics table
            commentBody += `| Metric | Value |\n`;
            commentBody += `|--------|-------|\n`;
            commentBody += `| ${statusColor} **Coverage** | **${percentage}%** |\n`;
            commentBody += `| Lines Covered | ${covered} |\n`;
            commentBody += `| Lines Missed | ${missed} |\n`;
            commentBody += `| Total Lines | ${total} |\n`;
            
            if (threshold > 0) {
              commentBody += `| Threshold | ${threshold}% |\n`;
              commentBody += `| Status | ${thresholdPassed === 'true' ? 'âœ… Passed' : 'âŒ Failed'} |\n`;
            }
            
            commentBody += `\n`;
            
            // Coverage guidelines
            commentBody += `<details>\n`;
            commentBody += `<summary>ğŸ“ˆ Coverage Guidelines</summary>\n\n`;
            commentBody += `| Coverage | Status | Description |\n`;
            commentBody += `|----------|--------|-------------|\n`;
            commentBody += `| 80%+ | ğŸŸ¢ Excellent | Well-tested code |\n`;
            commentBody += `| 60-80% | ğŸŸ¡ Good | Acceptable coverage |\n`;
            commentBody += `| 40-60% | ğŸŸ  Fair | Needs improvement |\n`;
            commentBody += `| <40% | ğŸ”´ Poor | Insufficient testing |\n\n`;
            commentBody += `</details>\n\n`;
            
            // Package breakdown
            const packageBreakdown = `${{ steps.package-coverage.outputs.package_breakdown }}`;
            if (packageBreakdown && packageBreakdown.trim() !== '') {
              commentBody += `<details>\n`;
              commentBody += `<summary>ğŸ“¦ Coverage by Package (Top 10)</summary>\n\n`;
              commentBody += `\`\`\`\n`;
              commentBody += packageBreakdown;
              commentBody += `\n\`\`\`\n\n`;
              commentBody += `</details>\n\n`;
            }
            
            // Recommendations
            if (parseFloat(percentage) < 60) {
              commentBody += `### ğŸ’¡ Recommendations\n\n`;
              commentBody += `- Add unit tests for uncovered code paths\n`;
              commentBody += `- Focus on service and controller layers\n`;
              commentBody += `- Aim for at least 60% coverage before merging\n\n`;
            }
            
            commentBody += `---\n`;
            commentBody += `_Coverage calculated locally using JaCoCo â€¢ [Download detailed report](${context.payload.repository.html_url}/actions/runs/${context.runId})_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      # Display coverage in job summary
      - name: Display coverage summary
        run: |
          echo "## ğŸ“Š Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.percentage }}% ${{ steps.coverage.outputs.status_emoji }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.coverage.outputs.status_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Covered | ${{ steps.coverage.outputs.covered }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Missed | ${{ steps.coverage.outputs.missed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Lines | ${{ steps.coverage.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage %** | **${{ steps.coverage.outputs.percentage }}%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          THRESHOLD=${{ inputs.coverage-threshold }}
          if [ $THRESHOLD -gt 0 ]; then
            echo "### Threshold Check" >> $GITHUB_STEP_SUMMARY
            echo "- Required: $THRESHOLD%" >> $GITHUB_STEP_SUMMARY
            echo "- Actual: ${{ steps.coverage.outputs.percentage }}%" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.coverage.outputs.threshold_passed }}" = "true" ]; then
              echo "- Result: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Result: âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      # Fail if below threshold
      - name: Check coverage threshold
        if: inputs.fail-below-threshold && steps.coverage.outputs.threshold_passed == 'false'
        run: |
          echo "âŒ Coverage (${{ steps.coverage.outputs.percentage }}%) is below threshold (${{ inputs.coverage-threshold }}%)"
          exit 1
