name: Auto Version and Release

on:
  push:
    branches: [main]

# Prevent concurrent version bumps
concurrency:
  group: version-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analyze:
    name: Analyze Commits
    runs-on: ubuntu-latest
    outputs:
      should_bump: ${{ steps.analysis.outputs.should_bump }}
      bump_type: ${{ steps.analysis.outputs.bump_type }}
      commit_summary: ${{ steps.analysis.outputs.commit_summary }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Analyze commits
        id: analysis
        run: |
          echo "ðŸ” Analyzing commits for version bump..."
          
          # Skip if this is a version bump commit
          if git log -1 --pretty=%B | grep -q "\[skip ci\]"; then
            echo "â­ï¸  Skipping - this is a version bump commit"
            echo "should_bump=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get last version tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "ðŸ“Œ No previous tags found, analyzing all commits"
            COMMITS=$(git log --pretty=format:"%s" --reverse)
          else
            echo "ðŸ“Œ Last version: $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" --reverse)
          fi
          
          # Count commits
          COMMIT_COUNT=$(echo "$COMMITS" | grep -v '^$' | wc -l)
          echo "ðŸ“Š Found $COMMIT_COUNT commits to analyze"
          
          if [ $COMMIT_COUNT -eq 0 ]; then
            echo "â­ï¸  No commits to analyze"
            echo "should_bump=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Display commits being analyzed
          echo "ðŸ“ Commits:"
          echo "$COMMITS"
          echo ""
          
          # Analyze commit types
          HAS_BREAKING=false
          HAS_FEAT=false
          HAS_FIX=false
          
          # Check for breaking changes
          if echo "$COMMITS" | grep -qiE "^(feat|fix|perf|refactor)!:|BREAKING CHANGE:"; then
            HAS_BREAKING=true
            echo "ðŸ’¥ Breaking change detected"
          fi
          
          # Check for features
          if echo "$COMMITS" | grep -qiE "^feat(\(.*\))?:"; then
            HAS_FEAT=true
            echo "âœ¨ Feature detected"
          fi
          
          # Check for fixes or performance improvements
          if echo "$COMMITS" | grep -qiE "^(fix|perf)(\(.*\))?:"; then
            HAS_FIX=true
            echo "ðŸ› Fix/Performance improvement detected"
          fi
          
          # Determine bump type
          if [ "$HAS_BREAKING" = true ]; then
            BUMP_TYPE="major"
            echo "ðŸ“ˆ Decision: MAJOR version bump (breaking change)"
          elif [ "$HAS_FEAT" = true ]; then
            BUMP_TYPE="minor"
            echo "ðŸ“ˆ Decision: MINOR version bump (new feature)"
          elif [ "$HAS_FIX" = true ]; then
            BUMP_TYPE="patch"
            echo "ðŸ“ˆ Decision: PATCH version bump (bug fix)"
          else
            echo "â­ï¸  No version bump needed (chore/docs/style/test/refactor)"
            echo "should_bump=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Generate commit summary
          SUMMARY=$(echo "$COMMITS" | sed 's/^/- /')
          
          echo "should_bump=true" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "commit_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  version:
    name: Bump Version
    needs: analyze
    if: needs.analyze.outputs.should_bump == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      old_version: ${{ steps.bump.outputs.old_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Bump version
        id: bump
        run: |
          BUMP_TYPE="${{ needs.analyze.outputs.bump_type }}"
          echo "ðŸŽ¯ Bump type: $BUMP_TYPE"
          
          # Get current version
          CURRENT=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "ðŸ“¦ Current version: $CURRENT"
          
          # Parse version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          # Calculate new version
          case "$BUMP_TYPE" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac
          
          echo "ðŸš€ New version: $NEW_VERSION"
          
          # Update pom.xml
          mvn versions:set -DnewVersion=$NEW_VERSION -DgenerateBackupPoms=false
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and tag
          git add pom.xml
          git commit -m "chore(release): bump version to $NEW_VERSION [skip ci]"
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
          
          # Push
          git push origin main
          git push origin "v$NEW_VERSION"
          
          echo "âœ… Version bumped and pushed!"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "old_version=$CURRENT" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          OLD_VERSION="${{ steps.bump.outputs.old_version }}"
          
          # Get commits for changelog
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            CHANGES=$(git log ${LAST_TAG}..v${NEW_VERSION} --pretty=format:"- %s (%h)" --reverse)
          fi
          
          # Categorize changes
          FEATURES=$(echo "$CHANGES" | grep -i "feat:" || echo "")
          FIXES=$(echo "$CHANGES" | grep -iE "fix:|perf:" || echo "")
          BREAKING=$(echo "$CHANGES" | grep -i "BREAKING CHANGE:" || echo "")
          OTHERS=$(echo "$CHANGES" | grep -viE "feat:|fix:|perf:|BREAKING CHANGE:" || echo "")
          
          # Create changelog
          cat > CHANGELOG.md << EOF
          # Release v${NEW_VERSION}
          
          **Version:** ${OLD_VERSION} â†’ ${NEW_VERSION}
          **Type:** ${{ needs.analyze.outputs.bump_type }} release
          **Date:** $(date +"%Y-%m-%d")
          
          EOF
          
          if [ ! -z "$BREAKING" ]; then
            cat >> CHANGELOG.md << EOF
          ## âš ï¸ Breaking Changes
          
          $BREAKING
          
          EOF
          fi
          
          if [ ! -z "$FEATURES" ]; then
            cat >> CHANGELOG.md << EOF
          ## âœ¨ Features
          
          $FEATURES
          
          EOF
          fi
          
          if [ ! -z "$FIXES" ]; then
            cat >> CHANGELOG.md << EOF
          ## ðŸ› Bug Fixes & Performance
          
          $FIXES
          
          EOF
          fi
          
          if [ ! -z "$OTHERS" ]; then
            cat >> CHANGELOG.md << EOF
          ## ðŸ”§ Other Changes
          
          $OTHERS
          
          EOF
          fi
          
          cat >> CHANGELOG.md << EOF
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${OLD_VERSION}...v${NEW_VERSION}
          EOF
          
          cat CHANGELOG.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.new_version }}
          name: Release v${{ steps.bump.outputs.new_version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Version Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Old Version:** \`${{ steps.bump.outputs.old_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** \`${{ steps.bump.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** \`${{ needs.analyze.outputs.bump_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changes Included" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.analyze.outputs.commit_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Docker Image
    needs: version
    uses: ./.github/workflows/docker-build-push.yml
    with:
      image_name: demo-app-2
      build_tool: maven
      java_version: '17'
      push_image: true
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
