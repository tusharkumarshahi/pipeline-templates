name: Build and Push Docker Image

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Docker image name'
        required: true
        type: string
      build_tool:
        description: 'Build tool: maven, gradle, go, npm'
        required: false
        type: string
        default: 'maven'
      java_version:
        description: 'Java version'
        required: false
        type: string
        default: '17'
      push_image:
        description: 'Push to Docker Hub (false for PRs)'
        required: false
        type: boolean
        default: true
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_TOKEN:
        required: true
    outputs:
      version:
        description: 'Version that was built'
        value: ${{ jobs.build.outputs.version }}
      image_tags:
        description: 'Image tags that were created'
        value: ${{ jobs.build.outputs.tags }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      # ===================================
      # STEP 1: Checkout code
      # ===================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===================================
      # STEP 2: Get version (SemVer)
      # ===================================
      - name: Get version
        id: version
        run: |
          # Try git tag first
          if git describe --tags --abbrev=0 2>/dev/null; then
            VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          # Try pom.xml
          elif [ -f "pom.xml" ]; then
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Try package.json
          elif [ -f "package.json" ]; then
            VERSION=$(node -p "require('./package.json').version")
          else
            VERSION="0.1.0"
          fi
          
          # Add commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: ${VERSION}"

      # ===================================
      # STEP 3: Setup Java (if needed)
      # ===================================
      - name: Setup Java
        if: inputs.build_tool == 'maven' || inputs.build_tool == 'gradle'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      # ===================================
      # STEP 4: Build Application
      # ===================================
      - name: Build with Maven
        if: inputs.build_tool == 'maven'
        run: |
          mvn clean package -DskipTests
          mkdir -p app
          cp target/*.jar app/app.jar

      - name: Build with Gradle
        if: inputs.build_tool == 'gradle'
        run: |
          ./gradlew build -x test
          mkdir -p app
          cp build/libs/*.jar app/app.jar

      - name: Setup Go
        if: inputs.build_tool == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Build with Go
        if: inputs.build_tool == 'go'
        run: |
          go build -o app/app ./...

      - name: Setup Node
        if: inputs.build_tool == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build with npm
        if: inputs.build_tool == 'npm'
        run: |
          npm ci
          npm run build
          mkdir -p app
          cp -r dist/* app/ || cp -r build/* app/

      # ===================================
      # STEP 5: Setup Docker
      # ===================================
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: inputs.push_image
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # ===================================
      # STEP 6: Generate Docker tags
      # ===================================
      - name: Generate tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.full_version }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      # ===================================
      # STEP 7: Build and Push
      # ===================================
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ inputs.push_image }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}:buildcache,mode=max

      # ===================================
      # STEP 8: Summary
      # ===================================
      - name: Build summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.push_image }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pull:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
